<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
    <title>Workflow Manager</title>
    <link rel="stylesheet" href="jquery-ui-1.11.1.custom/jquery-ui.css"></link> 
    <style>
	.hide{
		display:none;
	}
 	fieldset {
      		border: 0;
		margin-left: 0px;
    	}
    	label {
      		display: block;
    	}
    	select {
      		width: 200px;
    	}
    	.overflow {
      		height: 200px;
    	}
	#tabs {
		height: 500px;
		margin-left: 8px;
		margin-right: 8px;
	}	
	.dataTable {
		width: 75%;
    		border-collapse: collapse;
	}
	.needMoreInfo {
		font-size: 15px;	
		font-weight: bold;
	}
	td,th {
    		border: 1px solid black;
		text-align: left;
		padding: 10px;
	}
	#main {
    		font-size: 10px;
	}
	.validateTips {
		font-size: 12px;
		font-weight: bold;
	}
    </style>
    <script language="javascript" type="text/javascript" src="jquery-1.11.1.min.js"></script>
    <script language="javascript" type="text/javascript" src="jquery-ui-1.11.1.custom/jquery-ui.js"></script>

    <script>
// Globals
var host="10.0.3.15";
var baseURL = "https://"+host+":8443/rest/v1.0/";
var dialog;

// Login and get things started
function login()
{
	$.ajax({
		type: "POST",
    		url: baseURL+"sessions",
		xhrFields: {
      			withCredentials: true
   		},
    		success: function(result) {
			$("#pageContainer").toggleClass();
    		},
		error: function(result) {
			console.log(result.responseText);
			$("#loginMessage").html('<span class="error">Error: Make sure you have setup up your SSL certs correctly, or see the Commander documentation for development work - <a href="http://docs.electric-cloud.com/commander_doc/5_2/HTML5/Help/CommanderHelpHTML.htm#restapiaccess.htm%3FTocPath%3DHow%20to%20Use%20the%20REST%20API%7C_____1">Accessing the REST API</a></span');
		}
	});
}

// Get all data for page
function initData()
{
	$.ajax({
		type: "GET",
		url: baseURL+"projects",
		xhrFields: {
			withCredentials: true
		},
		success: function(result) {
			if( result.project ){
				var options;
				$.each(result.project, function(i, val){
					if( !val.pluginName){
                                        	options += '<option>'+val.projectName+'</option>';
					}
                                });
				$("#projects").append( options );
			}
		}
	});
}

function projectChange()
{
	var currentProj= $( "select option:selected" ).text();
	if( currentProj ){
		$.ajax({
			type: "GET",
			url: baseURL+"projects/"+currentProj+"/workflowDefinitions",
			xhrFields: {
				withCredentials: true
			},
			success: function(result) {
				if( result.workflowDefinition){
					var workflowData = '<table class="dataTable">';
					workflowData += '<tr><th>Name</th><th>Desc</th><th>Edit</th><th>Run</th></tr>';
					$.each(result.workflowDefinition, function(i, val){
						workflowData += '<tr><td>'+val.workflowDefinitionName+'</td>';
						workflowData += '<td>'+val.description+'</td>';
						workflowData += '<td><button class="editButton">Modify</button></td>';
						workflowData += '<td><button class="runButton" value="'+val.workflowDefinitionName+'">Run</button></td></tr>';
                      	         	});
					workflowData += '</table>';
					$("#tabs-1").html( workflowData );
					$(".editButton").button();
					$(".runButton").button().click( runWorkflow );

				}
				else{
					$("#tabs-1").html( '<div class="needMoreInfo">No workflow definitions found for project: '+currentProj+' - Create one?</div>' );
				}

			}
		});

	}	
}

function runWorkflow( event ) 
{
	event.preventDefault();
	var currentProj= $.trim($( "select option:selected" ).text());
	var currentWorkflowDef = this.value;

	if( currentProj && currentWorkflowDef ){
		$.ajax({
			type: "GET",
			url: encodeURI(baseURL+"projects/"+currentProj+"/workflowDefinitions/"+currentWorkflowDef+"/stateDefinitions?includeFormalParameters=true&startableOnly=true"),
			xhrFields: {
				withCredentials: true
			},
			success: function( result ) {
				var stateDef = result.stateDefinition[0];
				var paramFormText = '';
				if( stateDef.formalParameter ){
					$.each( stateDef.formalParameter, function( i, param) {
						// In the future I'll need to figure out why type of
						// parameter we have and account for that in the GUI.  For now
						// I'm just treating everything as a text type
      						paramFormText += '<label for="param_'+i+'">'+param.formalParameterName+'</label>';
      						paramFormText += '<input type="text" name="'+param.formalParameterName+'" id="param_'+i+'" class="inputParams">';
					});
				}

				if( paramFormText ){
      					paramFormText += '<input type="hidden" id="currentWorkflowDef" value="'+currentWorkflowDef+'">';
      					paramFormText += '<input type="submit" tabindex="-1" style="position:absolute; top:-1000px">';
				}
				else{
					paramFormText = 'No required parameters';
				}
				$("#runWorkflowDialog").html( paramFormText );
				// Open dialog now that we have parameters
				dialog.dialog( "open" );
			},
			error: function(result) {
				console.log( result );
			}
		});
	}
}

function launchWorkflow()
{
	event.preventDefault();
	// Before I close the dialog, I need to check that we have the required parameters
	// For now, we're going to run assuming we're all good
	dialog.dialog( "close" );

	var currentProj= $.trim($( "select option:selected" ).text());
	var currentWorkflowDef = $("#currentWorkflowDef").val();
	var parameterString = '{';

	$(".inputParams" ).each(function(index){
		parameterString+=this.name+":"+this.value+",";
	});
	// Pop the last ',' off the string and close the JSON object
	parameterString = parameterString.substring( 0, parameterString.length - 1 ) + '}';
	console.log( parameterString );

	if( currentProj && currentWorkflowDef && parameterString ){
		$.ajax({
			type: "POST",
			url: baseURL+"workflows",
			data: JSON.stringify({"projectName":currentProj,"workflowDefinitionName":currentWorkflowDef,"actualParameters":parameterString}),
			dataType: "json",
			xhrFields: {
				withCredentials: true
			},
			success: function(result) {
				$("#tabs-3").html( "Running workflow..." );
				$("#tabs").tabs({ active: 3 });
			},
			error: function(result){
				console.log( result );
				}
			});
	}
}

// When the browser is ready, start the
// dashboard
$(document).ready( function() {

	// Enable CORS on IE
	$.support.cors = true;

	// Setup the UI
	dialog = $( "#dialog-workflow-launch").dialog({
      			autoOpen: false,
      			height: 300,
      			width: 350,
      			modal: true,
      			buttons: {
        			"Launch workflow": launchWorkflow,
        			Cancel: function() {
          					dialog.dialog( "close" );
        				}
      				},
      			close: function() {
      				}
    			});

	$("#tabs").tabs({ active: 0 });
	$("#projects").selectmenu({
		select: function( event, ui ){
			projectChange();
		}
	});
	
      	login();
	initData();
});
    </script>
</head>
<body id="main">

<div id="loginMessage"></div>

<div id="dialog-workflow-launch" title="Launch Workflow">
  <p class="validateTips">Parameters</p>
 
  <form>
    <fieldset id="runWorkflowDialog" >
      <!-- Place holder for dynamically built dialog -->
    </fieldset>
  </form>
</div>

<div id="pageContainer" class="hide">
	<div id="runWorkflow" class="workflowInfo">
		<form action="#" id="changeProject">
  			<fieldset>
    				<select name="projects" id="projects">
    				</select>
  			</fieldset>
		</form>
	</div>
	<div id="tabs">
  		<ul>
    			<li><a href="#tabs-1">Run Workflow</a></li>
    			<li><a href="#tabs-2">Workflow History</a></li>
    			<li><a href="#tabs-3">Running Workflows</a></li>
  		</ul>
  		<div id="tabs-1">
  		</div>
  		<div id="tabs-2">
  		</div>
  		<div id="tabs-3">
  		</div>
	</div>
</div>
</body>
</html>
