<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
    <title>Workflow Manager</title>
    <link rel="stylesheet" href="jquery-ui-1.11.1.custom/jquery-ui.css"></link> 
    <style>
	.hide{
		display:none;
	}
 	fieldset {
      		border: 0;
		margin-left: 0px;
    	}
    	label {
      		display: block;
    	}
    	select {
      		width: 200px;
    	}
    	.overflow {
      		height: 200px;
    	}
	#tabs {
		height: 500px;
		margin-left: 8px;
		margin-right: 8px;
	}	
	.dataTable {
		width: 75%;
    		border-collapse: collapse;
	}
	.needMoreInfo {
	}
	td,th {
    		border: 1px solid black;
		text-align: left;
		padding: 10px;
	}
	#main {
    		font-size: 10px;
	}
    </style>
    <script language="javascript" type="text/javascript" src="jquery-1.11.1.min.js"></script>
    <script language="javascript" type="text/javascript" src="jquery-ui-1.11.1.custom/jquery-ui.js"></script>

    <script>
// Globals
var host="10.0.3.15";
var baseURL = "https://"+host+":8443/rest/v1.0/";

// Login and get things started
function login()
{
	$.ajax({
		type: "POST",
    		url: baseURL+"sessions",
		xhrFields: {
      			withCredentials: true
   		},
    		success: function(result) {
			$("#pageContainer").toggleClass();
    		},
		error: function(result) {
			console.log(result.responseText);
			$("#loginMessage").html('<span class="error">Error: Make sure you have setup up your SSL certs correctly, or see the Commander documentation for development work - <a href="http://docs.electric-cloud.com/commander_doc/5_2/HTML5/Help/CommanderHelpHTML.htm#restapiaccess.htm%3FTocPath%3DHow%20to%20Use%20the%20REST%20API%7C_____1">Accessing the REST API</a></span');
		}
	});
}

// Get all data for page
function initData()
{
	$.ajax({
		type: "GET",
		url: baseURL+"projects",
		xhrFields: {
			withCredentials: true
		},
		success: function(result) {
			if( result.project ){
				var options;
				$.each(result.project, function(i, val){
					if( !val.pluginName){
                                        	options += '<option>'+val.projectName+'</option>';
					}
                                });
				$("#projects").append( options );
			}
		}
	});
}

function projectChange()
{
	var currentProj= $( "select option:selected" ).text();
	if( currentProj ){
		$.ajax({
			type: "GET",
			url: baseURL+"projects/"+currentProj+"/workflowDefinitions",
			xhrFields: {
				withCredentials: true
			},
			success: function(result) {
				if( result.workflowDefinition){
					var workflowData = '<table class="dataTable">';
					workflowData += '<tr><th>Name</th><th>Desc</th><th>Edit</th><th>Run</th></tr>';
					$.each(result.workflowDefinition, function(i, val){
						workflowData += '<tr><td>'+val.workflowDefinitionName+'</td>';
						workflowData += '<td>'+val.description+'</td>';
						workflowData += '<td><input type="checkbox" class="check" id="editCheck_'+i+'"><label for="editCheck_'+i+'">Modify</label></td>';
						workflowData += '<td><input type="checkbox" class="check" id="runCheck_'+i+'" value="'+val.workflowDefinitionName+'"><label for="runCheck_'+i+'">Run</label></td></tr>';
                      	         	});
					workflowData += '</table>';
					workflowData += '<div style="width:75%;text-align:right;"><button>Run selected</button></div>';
					$("#tabs-1").html( workflowData );
					$(".check").button();
					
					$( "button" )
      					.button()
      					.click(runWorkflow);
				}
				else{
					$("#tabs-1").html( '<div class="needMoreInfo">No workflow definitions found for project: '+currentProj+' - Create one?</div>' );
				}

			}
		});

	}	
}

function runWorkflow( event ) 
{
	event.preventDefault();
	var currentProj= $.trim($( "select option:selected" ).text());
	var checkedWorkflows = $(".check:checked");

	if( currentProj && checkedWorkflows.length > 0 ){
		$.each( checkedWorkflows, function( i, val) {
			//First get the start state with parameters
			//so we can display a dialog
			$.ajax({
				type: "GET",
				url: encodeURI(baseURL+"projects/"+currentProj+"/workflowDefinitions/"+val.value+"/stateDefinitions?includeFormalParameters=true&startableOnly=true"),
				xhrFields: {
					withCredentials: true
				},
				success: function( result ) {
					// From here, pop up a dialog for each workflow def
					// and get the parameters to pass to the next call
					// to launch the workflow
					var stateDef = result.stateDefinition[0];
					$.each( stateDef.formalParameter, function( i, val) {
						console.log( val.formalParameterName );
					});
				},
				error: function(result) {
					console.log( result );
				}
			});
	
			$.ajax({
				type: "POST",
				url: baseURL+"workflows",
				data: JSON.stringify({"projectName":currentProj,"workflowDefinitionName":val.value}),
				dataType: "json",
				xhrFields: {
					withCredentials: true
				},
				success: function(result) {
					alert( "Running workflow" );
				},
				error: function(result){
					console.log( result );
				}
			});
		})
	}
	else{
		alert( "Please select a workflow to run" );
	}
}

// When the browser is ready, start the
// dashboard
$(document).ready( function() {

	// Enable CORS on IE
	$.support.cors = true;

	// Setup the UI
	$("#tabs").tabs({ active: 0 });
	$("#projects").selectmenu({
		select: function( event, ui ){
			projectChange();
		}
	});
	
      	login();
	initData();
});
    </script>
</head>
<body id="main">

<div id="loginMessage"></div>

<div id="pageContainer" class="hide">
	<div id="runWorkflow" class="workflowInfo">
		<form action="#" id="changeProject">
  			<fieldset>
    				<select name="projects" id="projects">
    				</select>
  			</fieldset>
		</form>
	</div>
	<div id="tabs">
  		<ul>
    			<li><a href="#tabs-1">Run Workflow</a></li>
    			<li><a href="#tabs-2">Workflow History</a></li>
    			<li><a href="#tabs-3">Running Workflows</a></li>
  		</ul>
  		<div id="tabs-1">
  		</div>
  		<div id="tabs-2">
  		</div>
  		<div id="tabs-3">
  		</div>
	</div>
</div>
</body>
</html>
